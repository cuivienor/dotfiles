#!/usr/bin/env bash

# Shamelessly lifted from prime https://github.com/ThePrimeagen/tmux-sessionizer
# Tweaked using https://github.com/27medkamal/tmux-session-wizard/ as extra inspiration

switch_to() {
	if [[ -z $TMUX ]]; then
		tmux attach-session -t "$1"
	else
		tmux switch-client -t "$1"
	fi
}
has_session() {
	tmux list-sessions | grep -q "^$1:"
}

tmux_init() {
	if [ -f "$2/.t" ]; then
		tmux send-keys -t "$1" "source $2/.t" c-M
	elif [ -f "$HOME/.t" ]; then
		tmux send-keys -t "$1" "source $HOME/.t" c-M
	fi
}

# Function to find project directories in src
find_projects() {
	local search_dirs=()
	
	# Always include the original directories
	search_dirs+=("$HOME/dev" "$HOME")
	
	# Add src directories if they exist
	[[ -d "$HOME/src" ]] && search_dirs+=("$HOME/src")
	[[ -d "$HOME/dev/src" ]] && search_dirs+=("$HOME/dev/src")
	[[ -d "$HOME/work/src" ]] && search_dirs+=("$HOME/work/src")
	
	# For ~/dev and ~/, use the original shallow search (exclude hidden directories)
	find "$HOME/dev" "$HOME" -mindepth 1 -maxdepth 1 -type d ! -name ".*" 2>/dev/null
	
	# For src directories, do deep project detection
	local src_dirs=()
	[[ -d "$HOME/src" ]] && src_dirs+=("$HOME/src")
	[[ -d "$HOME/dev/src" ]] && src_dirs+=("$HOME/dev/src")
	[[ -d "$HOME/work/src" ]] && src_dirs+=("$HOME/work/src")
	
	if [[ ${#src_dirs[@]} -gt 0 ]]; then
		for dir in "${src_dirs[@]}"; do
			# Look for directories containing .git (actual projects) - but exclude the .git directories themselves
			find "$dir" -type d -name ".git" -exec dirname {} \; 2>/dev/null | while read -r project_dir; do
				# Only show if the project directory itself isn't hidden
				if [[ $(basename "$project_dir") != .* ]]; then
					echo "$project_dir"
				fi
			done
			
			# Also look for other project markers (exclude hidden directories from results)
			find "$dir" -type f \( -name "package.json" -o -name "Gemfile" -o -name "Cargo.toml" -o -name "go.mod" -o -name "pyproject.toml" -o -name "pom.xml" \) -exec dirname {} \; 2>/dev/null | while read -r project_dir; do
				# Only show if the project directory itself isn't hidden
				if [[ $(basename "$project_dir") != .* ]]; then
					echo "$project_dir"
				fi
			done
		done
	fi
}

if [[ $# -eq 1 ]]; then
	if [ -d "$1" ]; then
		selected=$(realpath "$1")
	else
		selected=$(_ZO_FZF_OPTS="--tmux=center" zoxide query --interactive "$1")
	fi
else
	selected="$(find_projects | sort -u | fzf --tmux=center)"
fi

if [[ -z $selected ]]; then
	exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $tmux_running ]] || ! has_session "$selected_name"; then
	tmux new-session -d -s "$selected_name" -c "$selected"
	tmux_init "$selected_name" "$selected"
fi

switch_to "$selected_name"
